<!DOCTYPE html>
<html th:lang="${#locale}" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="#{stats.title}">Mood Statistics</title>

    <!-- main app theme first, then page-specific styles -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css"/>
    <link rel="stylesheet" th:href="@{/css/statistics.css}" href="/css/statistics.css"/>
</head>
<body th:with="L=${#lists.isEmpty(param.lang) ? #locale.language : param.lang[0]}">

<nav class="lang-switch" role="navigation" aria-label="Language">
    <button id="lang-en" onclick="switchLang('en')">EN</button>
    <button id="lang-ko" onclick="switchLang('ko')">한국어</button>
    <button id="lang-ru" onclick="switchLang('ru')">RU</button>
</nav>

<main class="page-center">
    <section class="section wide">
        <h2 style="text-align:center" th:text="#{stats.title}">Mood Statistics</h2>

        <h3 class="sec-title" th:text="#{stats.dailyMood}">Moods by Date</h3>
        <div class="charts">
            <div class="chart-block lines-block">
                <div class="month-toolbar">
                    <button class="stylish-btn" id="prevMonth" th:text="#{stats.prev}" aria-label="Previous month">⟵ Prev</button>
                    <span id="monthLabel" class="month-label">—</span>
                    <button class="stylish-btn" id="nextMonth" th:text="#{stats.next}" aria-label="Next month">Next ⟶</button>
                    <button class="stylish-btn" id="thisMonth" data-variant="gray" th:text="#{stats.thisMonth}">This Month</button>
                </div>
                <canvas id="moodMonthlyLines" height="280"></canvas>
                <div id="monthlyNoData" style="display:none;text-align:center;margin-top:8px;color:#9fb0c6;font-weight:700"
                     th:text="#{stats.noData}">No data for this month.</div>
            </div>
        </div>

        <h3 class="sec-title" th:text="#{stats.mainPieTitle}">Main Mood Distribution</h3>
        <div class="charts">
            <div class="chart-block pie-block">
                <canvas id="moodChart" height="240" width="240"></canvas>
            </div>
        </div>

        <h3 class="sec-title" th:text="#{stats.subPieTitle}">Submood Breakdown</h3>
        <div id="subMoodChartsContainer"></div>

        <div style="margin-top:14px;text-align:center">
            <a class="stylish-btn" data-variant="gray"
               th:href="@{/index(lang=${L})}" href="/index"> <span th:text="#{nav.backMain}">Back to Main</span></a>
        </div>
    </section>
</main>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<!-- i18n bootstrap -->
<script th:inline="javascript">
    window.I18N = Object.assign({}, window.I18N || {}, {
      mood_bad:     /*[[#{mood.bad}]]*/     'Bad',
      mood_poor:    /*[[#{mood.poor}]]*/    'Poor',
      mood_neutral: /*[[#{mood.neutral}]]*/ 'Neutral',
      mood_good:    /*[[#{mood.good}]]*/    'Good',
      mood_best:    /*[[#{mood.best}]]*/    'Best',
      stats_mainPieTitle:   /*[[#{stats.mainPieTitle}]]*/ 'Main Mood Distribution',
      stats_subPieTitle:    /*[[#{stats.subPieTitle}]]*/  'Submood Breakdown',
      stats_dailyMoodTitle: /*[[#{stats.dailyMood}]]*/    'Moods by Date (selected month)'
    });
    window.SUBMOOD_LABELS = {
      proud:/*[[#{mood.sub.proud}]]*/"Proud", grateful:/*[[#{mood.sub.grateful}]]*/"Grateful",
      energetic:/*[[#{mood.sub.energetic}]]*/"Energetic", excited:/*[[#{mood.sub.excited}]]*/"Excited",
      fulfilled:/*[[#{mood.sub.fulfilled}]]*/"Fulfilled", calm:/*[[#{mood.sub.calm}]]*/"Calm",
      productive:/*[[#{mood.sub.productive}]]*/"Productive", hopeful:/*[[#{mood.sub.hopeful}]]*/"Hopeful",
      motivated:/*[[#{mood.sub.motivated}]]*/"Motivated", friendly:/*[[#{mood.sub.friendly}]]*/"Friendly",
      indifferent:/*[[#{mood.sub.indifferent}]]*/"Indifferent", blank:/*[[#{mood.sub.blank}]]*/"Blank",
      tired:/*[[#{mood.sub.tired}]]*/"Tired", bored:/*[[#{mood.sub.bored}]]*/"Bored",
      quiet:/*[[#{mood.sub.quiet}]]*/"Quiet", frustrated:/*[[#{mood.sub.frustrated}]]*/"Frustrated",
      overwhelmed:/*[[#{mood.sub.overwhelmed}]]*/"Overwhelmed", nervous:/*[[#{mood.sub.nervous}]]*/"Nervous",
      insecure:/*[[#{mood.sub.insecure}]]*/"Insecure", confused:/*[[#{mood.sub.confused}]]*/"Confused",
      angry:/*[[#{mood.sub.angry}]]*/"Angry", sad:/*[[#{mood.sub.sad}]]*/"Sad",
      lonely:/*[[#{mood.sub.lonely}]]*/"Lonely", anxious:/*[[#{mood.sub.anxious}]]*/"Anxious",
      hopeless:/*[[#{mood.sub.hopeless}]]*/"Hopeless"
    };

    const CUR_LANG=(new URLSearchParams(location.search).get('lang'))||/*[[${L}]]*/'en';
    function switchLang(lang){const u=new URL(location.href);u.searchParams.set('lang',lang);location.href=u.toString();}
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('lang-'+CUR_LANG)?.classList.add('active');
      document.documentElement.lang = CUR_LANG;
      document.querySelectorAll('a[href^="/"],a[href^="./"],a[href^="../"]').forEach(a=>{
        try{const u=new URL(a.href,location.origin);
          if(!u.searchParams.get('lang')){u.searchParams.set('lang',CUR_LANG);a.href=u.pathname+u.search;}
        }catch{}
      });
    });
</script>

<script th:src="@{/js/statistics.js}" src="/js/statistics.js"></script>
</body>
</html>
