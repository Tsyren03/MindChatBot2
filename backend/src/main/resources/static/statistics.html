<!-- statistics.html (Mood Statistics, dark iOS style) -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mood Statistics</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css" />
    <link rel="stylesheet" th:href="@{/css/auth.css}" href="/css/auth.css" />
    <style>
        .page-center{min-height:100dvh;display:grid;place-items:center;padding:clamp(12px,3vw,32px)}
        .section.wide{max-width:1100px;width:100%}
        .charts{display:flex;flex-wrap:wrap;gap:24px;justify-content:center}
        .chart-block{flex:1 1 460px;max-width:640px}
        canvas{
          background: transparent; /* let the card glass show through */
          border:1px solid var(--ios-separator);
          border-radius:16px;
          padding:8px;
          max-width:100%;
        }
        #subMoodChartsContainer{display:flex;flex-wrap:wrap;gap:24px;justify-content:center}
        #subMoodChartsContainer .mini{width:260px}
        .mini h4{margin:0 0 8px 0;text-align:center;font-weight:800}
    </style>
</head>
<body class="bg-grad-purple">
<main class="page-center">
    <section class="section wide">
        <h2 style="text-align:center">Mood Statistics</h2>

        <div class="charts">
            <div class="chart-block"><canvas id="moodChart" height="320"></canvas></div>
        </div>

        <div id="subMoodChartsContainer"></div>

        <div class="charts">
            <div class="chart-block"><canvas id="moodTrendChart" height="340"></canvas></div>
        </div>

        <div class="charts">
            <div class="chart-block"><canvas id="moodByHourChart" height="340"></canvas></div>
        </div>

        <div style="margin-top:14px;text-align:center">
            <a th:href="@{/}" href="/index.html" class="stylish-btn" data-variant="gray">‚Üê Back to Main</a>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Dark theme defaults for Chart.js
    Chart.defaults.color = '#e9eef6';
    const gridColor = 'rgba(255,255,255,.10)';
    const axisLabel = '#c7d1e3';

    const CATEGORY_COLORS = { bad:'#FF3B30', poor:'#FF9F0A', neutral:'#D1D5DB', good:'#34C759', best:'#0A84FF' };
    const SUBMOOD_COLORS = {
      best:{ proud:'#00E6D0',grateful:'#00B8FF',energetic:'#4D7CFE',excited:'#A259FF',fulfilled:'#FF66C4' },
      good:{ calm:'#6EE7B7',productive:'#34D399',hopeful:'#10B981',motivated:'#22C55E',friendly:'#A3E635' },
      neutral:{ indifferent:'#E5E7EB',blank:'#D1D5DB',tired:'#BFC5CD',bored:'#9AA3AE',quiet:'#6B7280' },
      poor:{ frustrated:'#FFE08A',overwhelmed:'#FFD166',nervous:'#FFB020',insecure:'#FF9F0A',confused:'#FF7A00' },
      bad:{ angry:'#FF6B6B',sad:'#FF3B30',lonely:'#E11D48',anxious:'#C81E1E',hopeless:'#8B0000' }
    };
    const SUBMOOD_LISTS = {
      best:["proud","grateful","energetic","excited","fulfilled"],
      good:["calm","productive","hopeful","motivated","friendly"],
      neutral:["indifferent","blank","tired","bored","quiet"],
      poor:["frustrated","overwhelmed","nervous","insecure","confused"],
      bad:["angry","sad","lonely","anxious","hopeless"]
    };

    fetch('/user/moods/stats')
      .then(r=>r.json())
      .then(data=>{
        // Main mood pie
        if (data?.mainMoodStats) {
          const s = data.mainMoodStats;
          new Chart(document.getElementById("moodChart").getContext("2d"), {
            type: "pie",
            data: {
              labels: ["Bad","Poor","Neutral","Good","Best"],
              datasets: [{
                data: [s.bad,s.poor,s.neutral,s.good,s.best],
                backgroundColor:[
                  CATEGORY_COLORS.bad, CATEGORY_COLORS.poor, CATEGORY_COLORS.neutral,
                  CATEGORY_COLORS.good, CATEGORY_COLORS.best
                ]
              }]
            },
            options: {
              plugins:{
                title:{ display:true, text:"Main Mood Distribution", color:'#e9eef6' },
                legend:{ labels:{ color:'#e9eef6' } }
              }
            }
          });
        }

        // Submood pies
        if (data?.subMoodStats) {
          const subStats = data.subMoodStats;
          const wrap = document.getElementById("subMoodChartsContainer");
          wrap.innerHTML = "";
          Object.keys(SUBMOOD_LISTS).forEach(main=>{
            const subs = SUBMOOD_LISTS[main];
            const values = subs.map(sub => (subStats[`${main}:${sub}`]||0));
            if (values.reduce((a,b)=>a+b,0) === 0) return;

            const c = document.createElement("div");
            c.className = "mini";
            c.innerHTML = `<h4>${main[0].toUpperCase()+main.slice(1)}</h4><canvas height="220"></canvas>`;
            wrap.appendChild(c);

            new Chart(c.querySelector("canvas").getContext("2d"),{
              type:"pie",
              data:{
                labels: subs.map(s=>s[0].toUpperCase()+s.slice(1)),
                datasets:[{
                  data: values,
                  backgroundColor: subs.map(s=>SUBMOOD_COLORS[main][s])
                }]
              },
              options:{ plugins:{ legend:{ labels:{ color:'#e9eef6' } } } }
            });
          });
        }

        // Trend line
        if (data?.moodTrend) {
          const labels = data.moodTrend.map(i=>i.date);
          const moods = ["bad","poor","neutral","good","best"];
          new Chart(document.getElementById("moodTrendChart").getContext("2d"), {
            type:"line",
            data:{
              labels,
              datasets: moods.map(m=>({
                label: m[0].toUpperCase()+m.slice(1),
                data: data.moodTrend.map(i=>i[m]),
                borderColor: CATEGORY_COLORS[m],
                backgroundColor: CATEGORY_COLORS[m] + '33', // translucent fill
                fill:false,
                tension:.2
              }))
            },
            options:{
              plugins:{ title:{display:true,text:"Mood Trend Over Time", color:'#e9eef6' }, legend:{ labels:{ color:'#e9eef6' } } },
              scales:{
                x:{ ticks:{ color:axisLabel }, grid:{ color:gridColor } },
                y:{ beginAtZero:true, ticks:{ color:axisLabel }, grid:{ color:gridColor } }
              }
            }
          });
        }

        // Hourly bars
        if (data?.moodByHour) {
          const labels = data.moodByHour.map(i=> i.hour + ":00");
          const moods = ["bad","poor","neutral","good","best"];
          new Chart(document.getElementById("moodByHourChart").getContext("2d"), {
            type:"bar",
            data:{
              labels,
              datasets: moods.map(m=>({
                label:m[0].toUpperCase()+m.slice(1),
                data:data.moodByHour.map(i=>i[m]),
                backgroundColor:CATEGORY_COLORS[m] + 'B3' // ~70% opacity
              }))
            },
            options:{
              responsive:true,
              plugins:{ title:{display:true,text:"Mood by Hour", color:'#e9eef6' }, legend:{ labels:{ color:'#e9eef6' } } },
              scales:{ x:{stacked:true,ticks:{ color:axisLabel },grid:{ color:gridColor }},
                       y:{stacked:true, beginAtZero:true, ticks:{ color:axisLabel },grid:{ color:gridColor }} }
            }
          });
        }
      })
      .catch(err=>console.error("stats error", err));
</script>
</body>
</html>
